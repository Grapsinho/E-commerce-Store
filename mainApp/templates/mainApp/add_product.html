<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Add Products</title>

    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha3/dist/css/bootstrap.min.css"
      rel="stylesheet"
      integrity="sha384-KK94CHFLLe+nY2dmCWGMq91rCGa5gtU4mk92HdvYe+M/SXH301p5ILy+dN9+nJOZ"
      crossorigin="anonymous"
    />

    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css"
    />

    <link
      rel="stylesheet"
      href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css"
    />

    <style>
      .btn155 {
        display: inline-block;
        padding: 10px 20px;
        background-color: #0d6efd;
        color: #fff;
        text-decoration: none;
        border-radius: 5px;
        transition: background-color 0.3s ease-in-out;
      }

      .btn155:hover {
        background-color: #0c5dd6;
      }

      .modal_container {
        place-content: center;
        background-color: white;
        box-shadow: 20px 20px 60px #929292, -20px -20px 60px #ffffff;
        width: 300px;
        height: 200px;
        margin: 0 auto;
        position: fixed;
        top: 30px;
        left: 50%;
        transform: translate(-50%);
        padding: 10px;
        border-radius: 10px;
        transition: all 0.3s;
        display: none;
      }
    </style>
  </head>
  <body>
    <div class="modal_container"></div>

    <main class="mt-5 mb-5">
      <div class="container">
        <a href="{% url 'home' %}">Go Home</a>

        <form class="row g-3 mt-3" enctype="multipart/form-data">
          <h2>Describe Your Product.</h2>

          <div class="col-md-6">
            <label for="formGroupExampleInput" class="form-label"
              >Category</label
            >
            <input
              type="text"
              class="form-control category"
              id="formGroupExampleInput"
              placeholder="A category that superficially describes your product."
            />
          </div>
          <div class="col-md-6">
            <label for="formGroupExampleInput2" class="form-label"
              >Sub Category</label
            >
            <input
              type="text"
              class="form-control sub_category"
              id="formGroupExampleInput2"
              placeholder="A category that deeply describes your product."
            />
          </div>
          <div class="col-md-6">
            <label for="formGroupExampleInput" class="form-label"
              >Product Name</label
            >
            <input
              type="text"
              class="form-control product_name"
              id="formGroupExampleInput"
              placeholder="Your Product Name."
            />
          </div>
          <div class="col-md-6 d-flex" style="flex-direction: column">
            <label for="exampleFormControlTextarea1" class="form-label"
              >Product Description</label
            >
            <textarea
              class="form-control, product_desc"
              id="exampleFormControlTextarea1"
              rows="3"
            ></textarea>
          </div>

          <h2 class="mt-5">Create Sub Products.</h2>

          <div class="cont_for_sub_pro">
            <div class="sub_prod1 row g-3" data-count="1">
              <div class="col-md-6">
                <label for="formGroupExampleInput" class="form-label"
                  >Sku</label
                >
                <input
                  type="text"
                  class="form-control product_sku necessary_form"
                  id="formGroupExampleInput"
                  placeholder="Enter Your Products SKU."
                  data-count="1"
                />
              </div>
              <div class="col-md-6">
                <label for="formGroupExampleInput2" class="form-label"
                  >Price $</label
                >
                <input
                  type="number"
                  min="1"
                  max="100000"
                  class="form-control product_price necessary_form"
                  id="formGroupExampleInput2"
                  placeholder="Enter your Products Price."
                  data-count="1"
                />
                <span
                  style="font-size: 0.8; color: red"
                  class="price_error"
                ></span>
              </div>
              <div class="col-md-6">
                <label for="formGroupExampleInput" class="form-label"
                  >Stock</label
                >
                <input
                  type="number"
                  min="1"
                  class="form-control product_stock necessary_form"
                  id="formGroupExampleInput"
                  placeholder="Stock."
                  data-count="1"
                />
                <span
                  style="font-size: 0.8; color: red"
                  class="stock_error"
                ></span>
              </div>
              <div class="col-md-6">
                <label for="formFile" class="form-label">Choose image</label>
                <input
                  class="form-control product_image necessary_form"
                  type="file"
                  id="formFile"
                  name="image"
                  data-count="1"
                />
              </div>

              <h2 class="mt-5">Write down the features of the product</h2>

              <div class="attr_cont1" data-count="1">
                <div class="attributes_div1 d-flex" data-count="1">
                  <div class="col-md-6 attr_first">
                    <label for="formGroupExampleInput2" class="form-label"
                      >Attributes</label
                    >
                    <div class="d-flex align-items-center">
                      <input
                        type="text"
                        class="form-control product_attribute necessary_form"
                        id="formGroupExampleInput2"
                        placeholder="Color, Material etc..."
                        data-count="1"
                      />
                      :
                    </div>
                  </div>
                  <div class="col-md-6 attr_first_value">
                    <label for="formGroupExampleInput" class="form-label"
                      >Attribute Value</label
                    >
                    <input
                      type="text"
                      class="form-control product_attribute_value necessary_form"
                      id="formGroupExampleInput"
                      placeholder="Red, Blue, Cotton etc..."
                      data-count="1"
                    />
                  </div>
                </div>
              </div>
              <button
                class="btn btn-secondary w-50 add_more_attr1"
                style="margin: 1rem auto"
                type="button"
                data-count="1"
              >
                Add More
              </button>

              <div class="col-12">
                <div class="form-check">
                  <input
                    class="form-check-input"
                    type="checkbox"
                    id="gridCheck"
                    checked
                    data-count="1"
                  />
                  <label class="form-check-label" for="gridCheck">
                    Is Default
                  </label>
                </div>

                <div
                  class="d-flex"
                  style="flex-direction: column; font-size: 0.9rem"
                >
                  <span>If You Check This</span>
                  <p>This Sub Product Will Be Shown On Default</p>
                </div>
              </div>
            </div>
          </div>

          <div class="col-12">
            <button type="button" class="btn btn-warning add_more_sbProduct">
              Add More Product
            </button>
          </div>

          <div class="col-12">
            <button type="button" class="btn btn-primary create_product_btn">
              Create
            </button>
          </div>
        </form>
      </div>
    </main>

    <!-- key იქნება category-term და value იქნება category-->
    {{category|json_script:'category-term'}}
    {{subCategory|json_script:'subCategory-term'}}

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script>
      $(document).ready(function () {
        function sanitizeInput(userInput) {
          // Remove all HTML tags from user input
          let sanitizedInput = userInput.replace(/(<([^>]+)>)/gi, "");
          return sanitizedInput;
        }

        const category = JSON.parse(
          document.getElementById("category-term").textContent
        );
        const subCategory = JSON.parse(
          document.getElementById("subCategory-term").textContent
        );

        $(function () {
          $(".category").autocomplete({
            source: category,
            minLength: 1,
          });
        });

        $(function () {
          $(".sub_category").autocomplete({
            source: subCategory,
            minLength: 1,
          });
        });

        const jwtToken = localStorage.getItem("access_token");

        function getCookie(name) {
          var cookieValue = null;
          if (document.cookie && document.cookie !== "") {
            var cookies = document.cookie.split(";");
            for (var i = 0; i < cookies.length; i++) {
              var cookie = jQuery.trim(cookies[i]);
              // Check if this cookie string begins with the name provided
              if (cookie.substring(0, name.length + 1) === name + "=") {
                cookieValue = decodeURIComponent(
                  cookie.substring(name.length + 1)
                );
                break;
              }
            }
          }
          return cookieValue;
        }
        var csrftoken = getCookie("csrftoken");

        let count1 = 1;

        let product_obj = {};
        let sub_prod_obj = {};

        // add attributes for first div that will shown on default
        $(".add_more_attr1")
          .off("click")
          .on("click", () => {
            if (
              $(".add_more_attr1").data("count") ===
              $(".attr_cont1").data("count")
            ) {
              $(`.attr_cont${$(".add_more_attr1").data("count")}`).append(
                `
                          <div class="attributes_div1 d-flex mt-2" data-count="${1}">
                              <div class="col-md-6 attr_first">
                                <div class="d-flex align-items-center">
                                  <input
                                    type="text"
                                    class="form-control product_attribute necessary_form"
                                    id="formGroupExampleInput2"
                                    placeholder="Color, Material etc..."
                                    data-count="${1}"
                                  />
                                  :
                                </div>
                              </div>
                              <div class="col-md-6 attr_first_value">
                                <input
                                  type="text"
                                  class="form-control product_attribute_value necessary_form"
                                  id="formGroupExampleInput"
                                  placeholder="Red, Blue, Cotton etc..."
                                  data-count="${1}"
                                />
                          </div>
                        </div>
                       `
              );
            }
          });

        $(".create_product_btn")
          .off("click")
          .on("click", () => {
            let everything_fine = false;
            let everything_fine1 = false;
            let everything_fine2 = false;
            let everything_fine3 = false;

            $(".necessary_form").each(function (index, element2) {
              if ($(element2).val() == "") {
                everything_fine = false;
              } else {
                everything_fine = true;
              }
            });

            if (!everything_fine) {
              alert("Please fill out all fields");
            }

            if ($(".product_price").val() <= 0) {
              $(".price_error").text("Price Should Be above 0");
              everything_fine1 = false;
            } else {
              everything_fine1 = true;
            }

            if ($(".product_stock").val() <= 0) {
              $(".stock_error").text("Stock Should Be above 0");
              everything_fine2 = false;
            } else {
              everything_fine2 = true;
            }

            if (!$(".form-check-input").is(":checked")) {
              alert("You must choose one default product");
              everything_fine3 = false;
            } else {
              everything_fine3 = true;
            }

            const product_category = document.querySelector(".category");
            const product_sub_category =
              document.querySelector(".sub_category");
            const product_name = document.querySelector(".product_name");
            const product_desc = document.querySelector(".product_desc");

            const product_sku = document.querySelector(".product_sku");
            const product_price = document.querySelector(".product_price");
            const product_stock = document.querySelector(".product_stock");
            const product_attribute =
              document.querySelectorAll(".product_attribute");
            const product_attribute_value = document.querySelectorAll(
              ".product_attribute_value"
            );

            const product_image = document.querySelector(".product_image");
            var formData = new FormData();
            formData.append("image", product_image.files[0]);

            if (
              everything_fine &&
              everything_fine1 &&
              everything_fine2 &&
              everything_fine3
            ) {
              product_obj = {
                "category": sanitizeInput(product_category.value),
                "product_sub_category": sanitizeInput(
                  product_sub_category.value
                ),
                "product_name": sanitizeInput(product_name.value),
                "product_desc": sanitizeInput(product_desc.value),
              };
              const id =
                product_sku.attributes.getNamedItem("data-count").value;

              sub_prod_obj = {
                [`product_id_${id}`]: {
                  "product_sku": sanitizeInput(product_sku.value),
                  "product_price": sanitizeInput(product_price.value),
                  "product_stock": sanitizeInput(product_stock.value),
                },
              };

              product_attribute.forEach((element, index) => {
                if (
                  sub_prod_obj[`product_id_${id}`][
                    `attr_${sanitizeInput(element.value)}`
                  ]
                ) {
                  sub_prod_obj[`product_id_${id}`][
                    `attr_${sanitizeInput(element.value)}`
                  ] += `,${sanitizeInput(
                    product_attribute_value[index].value
                  )}`;
                } else {
                  sub_prod_obj[`product_id_${id}`][
                    `attr_${sanitizeInput(element.value)}`
                  ] = sanitizeInput(product_attribute_value[index].value);
                }
              });

              formData.append("product_obj", JSON.stringify(product_obj));
              formData.append("sub_prod_obj", JSON.stringify(sub_prod_obj));

              console.log(product_obj, "magari");
              console.log(sub_prod_obj, "magari2");
            }

            let modalAdded = false;

            $.ajax({
              url: `${location.protocol}//${location.host}/ajax_viewFor_CreteProducts/`,
              type: "POST",
              headers: {
                "X-CSRFToken": csrftoken,
                "Authorization": `Bearer ${jwtToken}`,
              },
              processData: false,
              contentType: false,
              data: formData,
              success: function (data) {
                console.log(!data.message12521);
                if (!data.message12521) {
                  if (!modalAdded) {
                    $(".modal_container").css({
                      "display": "grid",
                    });

                    $(".modal_container").append(
                      `
                      <div class="modal12" style="text-align: center">
                        <h3 style="font-size: 1.4rem">Your Product Is Created</h3>
                        <a href="${location.protocol}//${location.host}/product_detail/${data.product.product_id}/" class="btn155">See Product</a>
                      </div>
                      `
                    );

                    modalAdded = true;
                  }
                } else {
                  if (!modalAdded) {
                    alert(data.message12521);
                  }
                  modalAdded = true;
                }
              },
              error: function (error) {
                console.error(error.responseJSON.error);

                if (error.responseJSON.error == "Token has expired") {
                  $.ajax({
                    url: `${location.protocol}//${location.host}/auth/jwt/refresh/`,
                    type: "POST",
                    headers: {
                      "X-CSRFToken": csrftoken,
                    },
                    contentType: "application/json",
                    data: JSON.stringify({
                      refresh: localStorage.getItem("refresh_token"),
                    }),
                    success: function (data) {
                      console.log(data);
                      localStorage.setItem("access_token", data.access);

                      ////////////////////////////////////////////////////
                      // when we refresh token we sending one more request
                      $.ajax({
                        url: `${location.protocol}//${location.host}/ajax_viewFor_CreteProducts/`,
                        type: "POST",
                        headers: {
                          "X-CSRFToken": csrftoken,
                          "Authorization": `Bearer ${localStorage.getItem(
                            "access_token"
                          )}`,
                        },
                        processData: false,
                        contentType: false,
                        data: formData,
                        success: function (data) {
                          console.log(!data.message12521);
                          if (!data.message12521) {
                            if (!modalAdded) {
                              $(".modal_container").css({
                                "display": "grid",
                              });

                              $(".modal_container").append(
                                `
                                  <div class="modal12" style="text-align: center">
                                    <h3 style="font-size: 1.4rem">Your Product Is Created</h3>
                                    <a href="${location.protocol}//${location.host}/product_detail/${data.product.product_id}/" class="btn155">See Product</a>
                                  </div>
                                `
                              );

                              modalAdded = true;
                            }
                          } else {
                            if (!modalAdded) {
                              alert(data.message12521);
                            }
                            modalAdded = true;
                          }
                        },
                        error: function (error) {
                          console.error(error);
                        },
                      });
                    },
                    error: function (error) {
                      console.error(error);
                    },
                  });
                }
              },
            });
          });

        // all codes from above are for the first sub-product

        $(".add_more_sbProduct")
          .off("click")
          .on("click", () => {
            count1++;

            // adding new sub product
            $(".cont_for_sub_pro").append(
              `
                  <div class="sub_prod${count1} sub_prod1 row g-3" data-count="${count1}">
                    <div class="col-md-6">
                      <label for="formGroupExampleInput" class="form-label"
                        >Sku</label
                      >
                      <input
                        type="text"
                        class="form-control product_sku necessary_form"
                        id="formGroupExampleInput"
                        placeholder="Enter Your Products SKU."
                        data-count="${count1}"
                      />
                    </div>
                    <div class="col-md-6">
                      <label for="formGroupExampleInput2" class="form-label"
                        >Price $</label
                      >
                      <input
                        type="number"
                        min="1"
                        max="100000"
                        class="form-control product_price necessary_form"
                        id="formGroupExampleInput2"
                        placeholder="Enter your Products Price."
                        data-count="${count1}"
                      />

                      <span
                        style="font-size: 0.8; color: red"
                        class="price_error"
                      ></span>
                    </div>
                    <div class="col-md-6">
                      <label for="formGroupExampleInput" class="form-label"
                        >Stock</label
                      >
                      <input
                        type="number"
                        min="1"
                        class="form-control product_stock necessary_form"
                        id="formGroupExampleInput"
                        placeholder="Stock."
                        data-count="${count1}"
                      />

                      <span
                        style="font-size: 0.8; color: red"
                        class="price_error"
                      ></span>
                    </div>
                    <div class="col-md-6">
                      <label for="formFile" class="form-label">Choose image</label>
                      <input
                        class="form-control product_image necessary_form"
                        type="file"
                        id="formFile"
                        data-count="${count1}"
                      />
                    </div>

                    <h2 class="mt-5">Write down the features of the product</h2>

                    <div class="attr_cont${count1}" data-count="${count1}">
                      <div class="attributes_div1 d-flex" data-count="${count1}">
                        <div class="col-md-6 attr_first">
                          <label for="formGroupExampleInput2" class="form-label"
                            >Attributes</label
                          >
                          <div class="d-flex align-items-center">
                            <input
                              type="text"
                              class="form-control product_attribute necessary_form"
                              id="formGroupExampleInput2"
                              placeholder="Color, Material etc..."
                              data-count="${count1}"
                            />
                            :
                          </div>
                        </div>
                        <div class="col-md-6 attr_first_value">
                          <label for="formGroupExampleInput" class="form-label"
                            >Attribute Value</label
                          >
                          <input
                            type="text"
                            class="form-control product_attribute_value necessary_form"
                            id="formGroupExampleInput"
                            placeholder="Red, Blue, Cotton etc..."
                            data-count="${count1}"
                          />
                        </div>
                      </div>
                    </div>
                    <button
                      class="btn btn-secondary w-50 add_more_attr"
                      style="margin: 1rem auto"
                      type="button"
                      data-count="${count1}"
                    >
                      Add More
                    </button>

                    <div class="col-12">
                      <div class="form-check">
                        <input
                          class="form-check-input"
                          type="checkbox"
                          id="gridCheck${count1}"
                          data-count="${count1}"
                        />
                        <label class="form-check-label" for="gridCheck${count1}">
                          Is Default
                        </label>
                      </div>

                      <div
                        class="d-flex"
                        style="flex-direction: column; font-size: 0.9rem"
                      >
                        <span>If You Check This</span>
                        <p>This Sub Product Will Be Shown On Default</p>
                      </div>

                      <div class="col-md-6 align-items-center">
                        <button
                          class="btn btn-danger w-50 remove_sub_product"
                          style="margin: 1rem auto"
                          type="button"
                          data-count="${count1}"
                        >
                          Delete
                        </button>
                       </div>
                    </div>
                  </div>
                  `
            );

            // when we add one more sub product then we can add more attribute to it
            $(".add_more_attr").each(function (index, element) {
              $(element)
                .off("click")
                .on("click", () => {
                  if (
                    $(element).data("count") ===
                    $(`.attr_cont${$(element).data("count")}`).data("count")
                  ) {
                    $(`.attr_cont${$(element).data("count")}`).append(
                      `
                          <div class="attributes_div1 d-flex mt-2" data-count="${count1}">
                              <div class="col-md-6 attr_first">
                                <div class="d-flex align-items-center">
                                  <input
                                    type="text"
                                    class="form-control product_attribute"
                                    id="formGroupExampleInput2"
                                    placeholder="Color, Material etc..."
                                    data-count="${count1}"
                                  />
                                  :
                                </div>
                              </div>
                              <div class="col-md-6 attr_first_value">
                                <input
                                  type="text"
                                  class="form-control product_attribute_value"
                                  id="formGroupExampleInput"
                                  placeholder="Red, Blue, Cotton etc..."
                                  data-count="${count1}"
                                />
                          </div>
                        </div>
                       `
                    );
                  }
                });
            });

            // doing same but now i remove sub product forms
            $(".remove_sub_product").each(function (index, element1) {
              $(element1)
                .off("click")
                .on("click", () => {
                  if (
                    $(element1).data("count") ===
                    $(`.sub_prod${$(element1).data("count")}`).data("count")
                  ) {
                    $(`.sub_prod${$(element1).data("count")}`).remove();
                  }
                });
            });

            $(".create_product_btn")
              .off("click")
              .on("click", () => {
                let everything_fine = false;
                let everything_fine1 = false;
                let everything_fine2 = false;
                let everything_fine3 = false;
                let everything_fine4 = false;

                $(".necessary_form").each(function (index, element2) {
                  if ($(element2).val() == "") {
                    everything_fine = false;
                  } else {
                    everything_fine = true;
                  }
                });

                if (!everything_fine) {
                  alert("Please fill out all fields");
                }

                $(".product_price").each(function (index, element21) {
                  if (parseInt($(element21).val()) <= 0) {
                    $(".price_error").each(function (index, element22) {
                      $(element22).text("Price Should Be above 0");
                    });
                    everything_fine1 = false;
                  } else {
                    everything_fine1 = true;
                  }
                });

                let prd_sku = document.querySelectorAll(".product_sku");

                console.log(prd_sku);

                for (let index = 0; index < prd_sku.length; index++) {
                  const element = prd_sku[index];

                  if (index != 0 && prd_sku[index - 1].value == element.value) {
                    console.log(prd_sku[index - 1]);
                    console.log(prd_sku[index - 1].value, element.value);

                    alert(
                      `Your Sub-products have same sku, please change it: ${element.value}`
                    );
                    everything_fine4 = false;
                  } else {
                    everything_fine4 = true;
                    console.log(index);
                  }
                }

                console.log(everything_fine4);

                $(".product_stock").each(function (index, element23) {
                  if (parseInt($(element23).val()) <= 0) {
                    $(".stock_error").each(function (index, element24) {
                      $(element24).text("Stock Should Be above 0");
                    });
                    everything_fine2 = false;
                  } else {
                    everything_fine2 = true;
                  }
                });

                let arr55 = [];
                let arr56 = [];

                $(".form-check-input").each(function (index, element26) {
                  if (!$(element26).is(":checked")) {
                    arr55.push(element26);
                  } else if ($(element26).is(":checked")) {
                    arr56.push(element26);
                  }
                });

                if (arr56.length === 1) {
                  everything_fine3 = true;
                } else if (arr56.length > 1) {
                  everything_fine3 = false;
                  alert("You Must Have Only One Default Product");
                } else if (arr56.length === 0) {
                  everything_fine3 = false;
                  alert("You Must Have One Default Product");
                }

                const product_category = document.querySelector(".category");
                const product_sub_category =
                  document.querySelector(".sub_category");
                const product_name = document.querySelector(".product_name");
                const product_desc = document.querySelector(".product_desc");

                var formData = new FormData();

                product_obj = {
                  "category": sanitizeInput(product_category.value),
                  "product_sub_category": sanitizeInput(
                    product_sub_category.value
                  ),
                  "product_name": sanitizeInput(product_name.value),
                  "product_desc": sanitizeInput(product_desc.value),
                };

                let arrt435 = [];

                formData.append("product_obj", JSON.stringify(product_obj));

                let modalAdded = false;

                for (
                  let iFor_cont = 0;
                  iFor_cont < $(".sub_prod1").length;
                  iFor_cont++
                ) {
                  let iFor_cont2 = iFor_cont + 1;
                  const product_sku = document.querySelectorAll(".product_sku");
                  const product_price =
                    document.querySelectorAll(".product_price");
                  const product_stock =
                    document.querySelectorAll(".product_stock");
                  const product_attribute =
                    document.querySelectorAll(".product_attribute");
                  const product_attribute_value = document.querySelectorAll(
                    ".product_attribute_value"
                  );
                  const form_check_input =
                    document.querySelectorAll(".form-check-input");

                  const product_image =
                    document.querySelectorAll(".product_image");

                  if (
                    everything_fine &&
                    everything_fine1 &&
                    everything_fine2 &&
                    everything_fine3 &&
                    everything_fine4
                  ) {
                    const id = iFor_cont;

                    formData.append("image", product_image[iFor_cont].files[0]);

                    sub_prod_obj = {
                      [`product_id_${id}`]: {
                        "product_sku": sanitizeInput(product_sku[id].value),
                        "product_price": sanitizeInput(product_price[id].value),
                        "product_stock": sanitizeInput(product_stock[id].value),
                        "form_check_input": form_check_input[id].checked,
                      },
                    };

                    arrt435.push(sub_prod_obj);

                    product_attribute.forEach((element, index) => {
                      if ($(element).data("count") - 1 === id) {
                        if (
                          sub_prod_obj[`product_id_${id}`][
                            `attr_${sanitizeInput(element.value)}`
                          ]
                        ) {
                          sub_prod_obj[`product_id_${id}`][
                            `attr_${sanitizeInput(element.value)}`
                          ] += sanitizeInput(
                            `,${product_attribute_value[index].value}`
                          );
                        } else {
                          sub_prod_obj[`product_id_${id}`][
                            `attr_${sanitizeInput(element.value)}`
                          ] = sanitizeInput(
                            product_attribute_value[index].value
                          );
                        }
                      }
                    });
                    formData.append("sub_prod_obj", JSON.stringify(arrt435));
                    formData.append("lent", $(".sub_prod1").length);
                  }
                }

                if (
                  everything_fine &&
                  everything_fine1 &&
                  everything_fine2 &&
                  everything_fine3 &&
                  everything_fine4
                ) {
                  $.ajax({
                    url: `${location.protocol}//${location.host}/ajax_viewFor_CreteProducts/`,
                    type: "POST",
                    headers: {
                      "X-CSRFToken": csrftoken,
                      "Authorization": `Bearer ${jwtToken}`,
                    },
                    processData: false,
                    contentType: false,
                    data: formData,
                    success: function (data) {
                      console.log(!data.message12521);
                      if (!data.message12521) {
                        if (!modalAdded) {
                          $(".modal_container").css({
                            "display": "grid",
                          });

                          $(".modal_container").append(
                            `
                                  <div class="modal12" style="text-align: center">
                                    <h3 style="font-size: 1.4rem">Your Product Is Created</h3>
                                    <a href="${location.protocol}//${location.host}/product_detail/${data.product.product_id}/" class="btn155">See Product</a>
                                  </div>
                                `
                          );

                          modalAdded = true;
                        }
                      } else {
                        if (!modalAdded) {
                          alert(data.message12521);
                        }
                        modalAdded = true;
                      }
                    },
                    error: function (error) {
                      console.error(error.responseJSON.error);

                      if (error.responseJSON.error == "Token has expired") {
                        $.ajax({
                          url: `${location.protocol}//${location.host}/auth/jwt/refresh/`,
                          type: "POST",
                          headers: {
                            "X-CSRFToken": csrftoken,
                          },
                          contentType: "application/json",
                          data: JSON.stringify({
                            refresh: localStorage.getItem("refresh_token"),
                          }),
                          success: function (data) {
                            console.log(data);
                            localStorage.setItem("access_token", data.access);

                            ////////////////////////////////////////////////////
                            // when we refresh token we sending one more request
                            $.ajax({
                              url: `${location.protocol}//${location.host}/ajax_viewFor_CreteProducts/`,
                              type: "POST",
                              headers: {
                                "X-CSRFToken": csrftoken,
                                "Authorization": `Bearer ${localStorage.getItem(
                                  "access_token"
                                )}`,
                              },
                              processData: false,
                              contentType: false,
                              data: formData,
                              success: function (data) {
                                console.log(!data.message12521);
                                if (!data.message12521) {
                                  if (!modalAdded) {
                                    $(".modal_container").css({
                                      "display": "grid",
                                    });

                                    $(".modal_container").append(
                                      `
                                  <div class="modal12" style="text-align: center">
                                    <h3 style="font-size: 1.4rem">Your Product Is Created</h3>
                                    <a href="${location.protocol}//${location.host}/product_detail/${data.product.product_id}/" class="btn155">See Product</a>
                                  </div>
                                `
                                    );

                                    modalAdded = true;
                                  }
                                } else {
                                  if (!modalAdded) {
                                    alert(data.message12521);
                                  }
                                  modalAdded = true;
                                }
                              },
                              error: function (error) {
                                console.error(error);
                              },
                            });
                          },
                          error: function (error) {
                            console.error(error);
                          },
                        });
                      }
                    },
                  });
                }
              });
          });
      });
    </script>
  </body>
</html>
